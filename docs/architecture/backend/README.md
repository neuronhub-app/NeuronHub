---
paths: **/*.py
---

## Constraints

- Django core is mostly untyped tech debt.
- Use async by default.

## Structure

- `schema.graphql` - the single GraphQL schema
- `server/pyproject.toml` -
- `server/persisted-queries.json` - Strawberry queries whitelist from gql.tada, generated by `mise lint`.
	- the enforcer and loader is at `apps.graphql.persisted_query_extension`

### `server/neuronhub`

- `apps/posts/` - core `Post` models (and projections)
	- `index.py` - Algolia index settings
- `apps/importer/` - importer of Posts from eg HackerNews
- `apps/users/` - models and API for `User`
- `apps/highlighter/` - models and API for users' `Post.content_*` highlights
- `apps/tests/` - `faker` `class Gen` factories, `db_stubs_repopulate`, pytest base class, etc

The structure of an app in `neuronhub.apps`:
1. `models.py` - only data definition
2. `services.py` - business logic
3. `tasks.py` - for `django_tasks` worker, mostly `services` wrappers. Uses DB backend
4. `graphql/{types,resolvers,mutations}.py` - API-only layer - uses `services`, `tasks`, and `models`.

Tags and votes are unified across `Post`'s `<<projection>>`s with models: `PostTag`, `PostVote`, `PostTagVote`.

```python
class Visibility(TextChoices):
    PRIVATE
    USERS_SELECTED
    CONNECTIONS
    SUBSCRIBERS
    INTERNAL
    PUBLIC
```

## Visibility

For privacy we override `PostTypeI.get_queryset` (Strawberry `interface` for each `Post` projection) by adding there `return filter_posts_by_user(user, posts=queryset)`, which filters by `post.visilibity` values.

Files:
- [[server/neuronhub/apps/posts/graphql/types.py]]
- [[server/neuronhub/apps/posts/services/filter_posts_by_user.py]]

## Mandatory task-specific docs

- [How to use pytest](./pytest.md)
