---
paths: **/*.py
---

## Constraints

- Django core is mostly untyped tech debt.
- Use async by default.

## Structure

- `schema.graphql` - the single GraphQL schema
- `server/pyproject.toml`
- `server/.venv` - uv venv
- `server/persisted-queries.json` - Strawberry queries whitelist from gql.tada, generated by `mise lint`
- `server/neuronhub/apps` - the core and extra apps

The structure of an App in `neuronhub.apps`:
1. `models.py` or `models/` - should contain only data definition
2. `services.py` or `services/` - business logic
3. `tasks.py` for `django.tasks` workers, mostly `services` wrappers. We use the DB backend.
4. `graphql.py` or `graphql/{types,resolvers,mutations}.py` - API-only layer - uses `services`, `tasks`, and `models`.

### `server/neuronhub`

- `apps/posts/` - core `Post` models (and projections)
    - `index.py` - Algolia index settings
    - Tags and votes are unified across `Post`'s `<<projection>>`s with models: `PostTag`, `PostVote`, `PostTagVote`.
- `apps/importer/` - importer of Posts from eg HackerNews
- `apps/users/` - models and API for `User`
- `apps/highlighter/` - models and API for users' `Post.content_*` highlights
- `apps/graphql/persisted_query_extension.py` - gql.tada whitelist loader and enforcer
- `apps/tests/` - `faker` `class Gen` factories, `db_stubs_repopulate`, pytest base class, etc
- `apps/profiles/` - [detailed doc](./profiles.md). Users' Profiles for Algolia directory, and LLM-powered matching.
	- `services/score_matches_by_llm.py` - calls LLM API to populate `ProfileMatch.match_score_by_llm` and `.match_reason_by_llm`
	- `services/summarize_match_reviews.py` - builds calibration examples from user review corrections, injected into LLM prompt

Tests are placed nearby named `{module_name}__test.py`.

## Visibility

As the core feature we override `PostTypeI.get_queryset` (`PostTypeI` is a Strawberry's `interface` for each `Post` projection) by adding there `return filter_posts_by_user(user, posts=queryset)`, which filters by `post.visilibity` values.

```python
class Visibility(TextChoices):
    PRIVATE
    USERS_SELECTED
    CONNECTIONS
    SUBSCRIBERS
    INTERNAL
    PUBLIC
```

Files:
- [[server/neuronhub/apps/posts/graphql/types.py]]
- [[server/neuronhub/apps/posts/services/filter_posts_by_user.py]]

### Algolia

Because Posts are indexed by Algolia, we give each logged in User a personal Search API token with "Restriction" as `["visible_to:group/INTERNAL", "visible_to:group/PUBLIC", "visible_to:{username}"]` through users/graphql/resolvers [[UsersQuery#get_algolia_search_key_with_user_perms]].

And the field `visible_to` is serialized for Algolia in posts/models/posts.py [[Post#get_visible_to]].


## Mandatory task-specific docs

- [How to use pytest](./pytest.md)
