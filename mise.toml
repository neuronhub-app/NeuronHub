[tools]
    bun = "latest"
    uv = "latest"

[settings]
    python.uv_venv_auto = true # use uv /server/.venv/, not Mise path


[tasks.install-deps]
    depends = [
        "install-deps-server",
        "install-deps-client",
        "install-deps-pytest",
        "install-deps-pytest-chromium",
        "install-deps-claude-code",
    ]
    alias = "install"

    [tasks.install-deps-server]
        dir = "server"
        run = "uv sync"

    [tasks.install-deps-client]
        dir = "client"
        run = "bun install"

    [tasks.install-deps-pytest]
        run = "uv tool install playwright"

    [tasks.install-deps-pytest-chromium]
        run = "uv tool run playwright install chromium --with-deps"

    [tasks.install-deps-claude-code]
        run = "bun install --global @anthropic-ai/claude-code @modelcontextprotocol/server-memory @modelcontextprotocol/server-sequential-thinking"


[tasks.dev-start]
    depends = ["dev-db", "dev-server", "dev-client"]
    alias = ["dev", "start"]

    [tasks.dev-server]
        depends = "dev-db"
        dir = "server"
        run = "uv run manage.py runserver"

    [tasks.dev-client]
        depends = "dev-db"
        dir = "client"
        run = "bun run dev --host"

    [tasks.dev-db]
        description = "start docker db, idempotently"
        run = "sudo docker compose --file ./devops/docker-compose.dev-db.yml up --detach"

    [tasks.dev-db-stop]
        run = "sudo docker compose --file ./devops/docker-compose.dev-db.yml down"


[tasks.pytest]
    run = "uv run pytest"
    depends = "dev-db"
    dir = "server"
    alias = "test"

[tasks.pytest-playwright]
    depends = "dev-db"
    dir = "server"
    run = "uv run pytest neuronhub/apps/tests/playwright"
    alias = ["playwright", "e2e"]

[tasks.claude]
    run = "claude --dangerously-skip-permissions"


[tasks.db-migrate]
    dir = "server"
    run = "uv run manage.py migrate"
    alias = "migrate"
[tasks.db-makemigrations]
    dir = "server"
    run = "uv run manage.py makemigrations"
    alias = "makemigrations"
[tasks.db-stubs-repopulate]
    dir = "server"
    run = "uv run manage.py db_stubs_repopulate"
    alias = ["db_stubs_repopulate", "db-stubs"]


[tasks.graphql-gen]
    depends = ["graphql-gen-server", "graphql-gen-client"]
    alias = ["codegen", "typegen"]

    [tasks.graphql-gen-server]
        dir = "server"
        run = "uv run manage.py export_schema neuronhub.graphql --path=../schema.graphql"

    [tasks.graphql-gen-client]
        dir = "client"
        run = [
            "bun run graphql-codegen --config src/codegen.ts",
            "bun run gql-tada generate output",
            "bunx @chakra-ui/cli typegen src/theme/theme.ts",
            "mise run format-client"
        ]


[tasks.format]
    depends = ["format-server", "format-client"]

    [tasks.format-server]
        dir = "server"
        run = "uv run ruff format ."

    [tasks.format-client]
        dir = "client"
        run = "bun run biome check --write"


[tasks.lint]
    depends = ["lint-server", "lint-client"]

    [tasks.lint-server]
        dir = "server"
        run = "uv run mypy neuronhub"
        alias = "mypy"

    [tasks.lint-client]
        dir = "client"
        run = "bun run tsc --noEmit"
        alias = "tsc"


[tasks.upgrade-deps]
    depends = [
        "upgrade-deps-server",
        "upgrade-deps-client",
        "upgrade-deps-pytest",
        "install-deps-pytest-chromium",
    ]
    alias = "upgrade"

    [tasks.upgrade-deps-server]
        dir = "server"
        run = "uv lock --upgrade"

    [tasks.upgrade-deps-client]
        dir = "client"
        run = [
            "bun run ncu --upgrade --packageManager",
            "bun install"
        ]

    [tasks.upgrade-deps-pytest]
        run = "uv tool upgrade playwright"

    [tasks.upgrade-deps-claude-code]
        run = "bun update --global @anthropic-ai/claude-code @modelcontextprotocol/server-memory @modelcontextprotocol/server-sequential-thinking"
